---
export const prerender = false; // SSR
import "../styles/login.css";
import favicon from "../../public/favicon.png";

const { cookies, redirect } = Astro;

const accessToken = cookies.get("sb-access-token");
const refreshToken = cookies.get("sb-refresh-token");

if (accessToken && refreshToken) {
  return redirect("/Dashboard");
}
---

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Login - Dashboard</title>
  <link rel="icon" type="image/png" href={favicon.src} />
</head>

<body>
  <div class="login-wrapper">
    <div class="login-container">
      <div class="login-card">
        <h1 class="login-title">Sign in</h1>

        <p class="login-subtitle">
          Ingresa con tus credenciales para acceder a la plataforma.
        </p>

        <form class="login-form" action="/api/auth/signin" method="post">
          <label>
            Email
            <input type="email" name="email" required />
          </label>

          <label>
            Password
            <input type="password" name="password" required />
          </label>

          <button type="submit">Login</button>
        </form>

        <!-- ✅ Registro -->
        <div class="login-divider" role="separator" aria-label="Separador"></div>

        <p class="login-register">
          ¿No tienes credenciales?
          <a href="/Registro-Profe">Crea una cuenta</a>
        </p>
      </div>
    </div>
  </div>
  <!-- ✅ Modal de error -->
  <div id="authErrorModal" class="modal-overlay" hidden>
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h2 id="modalTitle" class="modal-title">Credenciales incorrectas</h2>
      <p class="modal-text">
        El correo o la contraseña no son correctos. Inténtalo de nuevo.
      </p>

      <div class="modal-actions">
        <button type="button" id="closeModalBtn" class="modal-btn">
          Entendido
        </button>
      </div>
    </div>
  </div>
</body>

<script is:inline>
  const params = new URLSearchParams(window.location.search);
  const err = params.get("error");

  const overlay = document.getElementById("authErrorModal");
  const closeBtn = document.getElementById("closeModalBtn");

  function openModal() {
    overlay.hidden = false;
    document.body.style.overflow = "hidden";
    closeBtn?.focus?.();
  }

  function closeModal() {
    overlay.hidden = true;
    document.body.style.overflow = "";
    // Limpia el query param para que no vuelva a salir al recargar
    window.history.replaceState({}, "", window.location.pathname);
  }

  if (err === "invalid") openModal();

  closeBtn?.addEventListener("click", closeModal);

  // Cerrar si hacen click fuera del modal
  overlay?.addEventListener("click", (e) => {
    if (e.target === overlay) closeModal();
  });

  // Cerrar con ESC
  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && overlay && !overlay.hidden) closeModal();
  });
</script>

<style>
  /* Si ya lo manejas en login.css, puedes borrar este bloque */
  .login-subtitle {
    margin: 8px 0 18px;
    color: #64748b;
    font-size: 0.98rem;
    text-align: center;
  }

  .login-divider {
    height: 1px;
    background: rgba(15, 23, 42, 0.12);
    margin: 18px 0 12px;
  }

  .login-register {
    margin: 0;
    text-align: center;
    color: #64748b;
    font-size: 0.98rem;
  }

  .login-register a {
    color: #2563eb;
    font-weight: 700;
    text-decoration: underline;
    text-underline-offset: 3px;
    margin-left: 6px;
  }

.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(2, 6, 23, 0.55);
  display: grid;
  place-items: center;
  z-index: 9999;
  padding: 16px;
}

/* ✅ IMPORTANTE: respeta el atributo hidden */
.modal-overlay[hidden] {
  display: none !important;
}

.modal {
  width: min(420px, 100%);
  background: #ffffff;
  border-radius: 14px;
  padding: 18px 18px 16px;
  box-shadow: 0 18px 60px rgba(2, 6, 23, 0.25);
  border: 1px solid rgba(15, 23, 42, 0.08);
}

.modal-title {
  margin: 0 0 8px;
  font-size: 1.15rem;
  color: #0f172a;
}

.modal-text {
  margin: 0 0 14px;
  color: #475569;
  line-height: 1.4;
}

.modal-actions {
  display: flex;
  justify-content: flex-end;
}

.modal-btn {
  border: 0;
  border-radius: 10px;
  padding: 10px 14px;
  font-weight: 700;
  cursor: pointer;
  background: #2563eb;
  color: white;
}

</style>
