---
import DashboardLayout from '../layouts/DashboardLayout.astro';
import StatCard from '../components/Home/Statcard.astro';
import cargargrupo from "../../public/assets/cargar.png";
import asignar_practica from "../../public/assets/formacion.png";
import '../styles/style.css';

import { requireAuth } from "../lib/authGuard";
import { supabase } from "../lib/supabase";

// üîê Protegemos la ruta
const authResult = await requireAuth(Astro);

// Si requireAuth devolvi√≥ un Response (redirect), lo regresamos
if (authResult instanceof Response) {
  return authResult;
}

// üëç requireAuth devuelve: { user: User | null }
const user = authResult.user;

// UID de Supabase Auth
const authUid = user?.id;

// ‚ö†Ô∏è Fallback por si no existe nombre
let nombreCompleto = user?.email || "Usuario";

// üßë‚Äçüè´ Traer nombre del usuario desde tu tabla Usuarios
if (authUid) {
  const { data: usuario, error: usuarioError } = await supabase
    .from("Usuarios")
    .select("Nombre, Apellido_Paterno")
    .eq("auth_uid", authUid)
    .maybeSingle();

  if (usuarioError) {
    console.error("Error consultando usuario:", usuarioError);
  }

  if (usuario) {
    nombreCompleto = `${usuario.Nombre} ${usuario.Apellido_Paterno}`;
  }
}

// Obtener URL p√∫blica del Excel
const { data: excelData } = supabase
  .storage
  .from("Excel-CargarGrupo")              // bucket
  .getPublicUrl("Archivos/Grupo_Alta.xlsx");  // ruta exacta

const excelUrl = excelData.publicUrl;
---

<DashboardLayout pageTitle="Dashboard">
  <section class="content">

    <!-- üëá Aqu√≠ se muestra el nombre -->
    <h1 class="text-2xl font-semibold mb-4">
      Bienvenido, {nombreCompleto}
    </h1>

    <div class="stats">
      <StatCard type="grupos" label="Grupos registrados" />
      <StatCard type="practicas" label="Pr√°cticas activas" />
      <StatCard type="alumnos" label="Alumnos inscritos" />
    </div>

    <div class="actions">

      <!-- Bot√≥n para descargar Excel -->
      <a href={excelUrl} class="action">
        <div>
          <img src={cargargrupo.src} class="icon" alt="" />
          Descargar Excel (Alta)
        </div>
        <span>‚Üí</span>
      </a>

      <!-- Bot√≥n para ir a asignar.astro -->
      <a href="/Asignar" class="action">
        <div>
          <img src={asignar_practica.src} class="icon" alt="" />
          Asignar pr√°ctica
        </div>
        <span>‚Üí</span>
      </a>

    </div>

  </section>
</DashboardLayout>
