---
import Layout from "../layouts/Layout.astro";
import { createClient } from "@supabase/supabase-js";

export const prerender = false;

const sp = Astro.url.searchParams;

const supabase = createClient(
  import.meta.env.SUPABASE_URL,
  import.meta.env.SUPABASE_ANON_KEY
);

// SSR: traer grupos directo
const { data: grupos, error: gruposError } = await supabase
  .from("Grupos")
  .select("id, Nombre")
  .order("Nombre", { ascending: true });

// flags (fallback, por si el backend aún redirige)
const emailExists = sp.get("email_exists") === "1";
const boletaExists = sp.get("boleta_exists") === "1";
const passMismatch = sp.get("password_mismatch") === "1";
const rateLimit = sp.get("rate_limit") === "1";

// para re-llenar campos
const preEmail = sp.get("email") ?? "";
const preBoleta = sp.get("boleta") ?? "";
const preGrupo = sp.get("grupo") ?? "";
---

<Layout title="Register">
  <section class="auth">
    <div class="card">
      <header class="head">
        <h1>Registro</h1>
        <p class="sub">
          Llena los siguientes campos para darte de alta y comenzar a usar la app de realidad virtual.
          <br />
        </p>

        {rateLimit && (
          <p class="top-alert">
            Se alcanzó el límite de registros por correo (rate limit). Espera un momento e intenta de nuevo.
          </p>
        )}
      </header>

      <div class="divider"></div>

      <form action="/api/auth/register" method="post" class="register-form" id="registerForm">
        <div class="grid">
          <!-- Nombre(s) -->
          <div class="control">
            <div class="control-head">
              <span class="ico" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M12 12a4.5 4.5 0 1 0-4.5-4.5A4.5 4.5 0 0 0 12 12Z" stroke="currentColor" stroke-width="2"/>
                  <path d="M4 20c1.8-3.5 5-5 8-5s6.2 1.5 8 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </span>
              <label for="nombre">Nombre(s) <span class="req">*</span></label>
            </div>
            <div class="control-body">
              <span class="ico soft" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M12 12a4.5 4.5 0 1 0-4.5-4.5A4.5 4.5 0 0 0 12 12Z" stroke="currentColor" stroke-width="2"/>
                  <path d="M4 20c1.8-3.5 5-5 8-5s6.2 1.5 8 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </span>
              <input type="text" name="nombre" id="nombre" required placeholder="Ingresa tu nombre" />
            </div>
          </div>

          <!-- Apellido paterno -->
          <div class="control">
            <div class="control-head">
              <span class="ico" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M12 12a4.5 4.5 0 1 0-4.5-4.5A4.5 4.5 0 0 0 12 12Z" stroke="currentColor" stroke-width="2"/>
                  <path d="M4 20c1.8-3.5 5-5 8-5s6.2 1.5 8 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </span>
              <label for="apellidoPaterno">Apellido paterno <span class="req">*</span></label>
            </div>
            <div class="control-body">
              <span class="ico soft" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M12 12a4.5 4.5 0 1 0-4.5-4.5A4.5 4.5 0 0 0 12 12Z" stroke="currentColor" stroke-width="2"/>
                  <path d="M4 20c1.8-3.5 5-5 8-5s6.2 1.5 8 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </span>
              <input type="text" name="apellidoPaterno" id="apellidoPaterno" required placeholder="Ingresa tu apellido paterno" />
            </div>
          </div>

          <!-- Apellido materno -->
          <div class="control">
            <div class="control-head">
              <span class="ico" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M12 12a4.5 4.5 0 1 0-4.5-4.5A4.5 4.5 0 0 0 12 12Z" stroke="currentColor" stroke-width="2"/>
                  <path d="M4 20c1.8-3.5 5-5 8-5s6.2 1.5 8 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </span>
              <label for="apellidoMaterno">Apellido materno</label>
            </div>
            <div class="control-body">
              <span class="ico soft" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M12 12a4.5 4.5 0 1 0-4.5-4.5A4.5 4.5 0 0 0 12 12Z" stroke="currentColor" stroke-width="2"/>
                  <path d="M4 20c1.8-3.5 5-5 8-5s6.2 1.5 8 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </span>
              <input type="text" name="apellidoMaterno" id="apellidoMaterno" placeholder="(Opcional)" />
            </div>
          </div>

          <!-- Boleta -->
          <div class={`control ${boletaExists ? "is-error" : ""}`} id="boletaControl">
            <div class="control-head">
              <span class="ico" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M4 7h16v10H4z" stroke="currentColor" stroke-width="2" />
                  <path d="M7 10h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M7 14h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </span>
              <label for="boleta">Boleta <span class="req">*</span></label>
            </div>
            <div class="control-body">
              <span class="ico soft" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M4 7h16v10H4z" stroke="currentColor" stroke-width="2" />
                  <path d="M7 10h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M7 14h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </span>
              <input
                type="text"
                name="boleta"
                id="boleta"
                required
                inputmode="numeric"
                placeholder="Ingresa tu boleta"
                value={preBoleta}
              />
            </div>

            <!-- fallback por query -->
            {boletaExists && (
              <p class="hint-row hint-error">Esta boleta ya existe.</p>
            )}

            <!-- mensaje por precheck (JS) -->
            <p class="hint-row hint-error" id="boletaExistsMsg" hidden>
              Esta boleta ya existe.
            </p>
          </div>

          <!-- Grupo (full) - SSR -->
          <div class="control span-2">
            <div class="control-head">
              <span class="ico teal" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M7 8h10M7 12h10M7 16h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </span>
              <label for="grupo">Grupo <span class="req">*</span></label>
            </div>

            <div class="control-body">
              <span class="ico soft" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M7 8h10M7 12h10M7 16h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </span>

              <select name="grupo" id="grupo" required>
                {gruposError ? (
                  <option value="" selected disabled>❌ Error cargando grupos</option>
                ) : !grupos?.length ? (
                  <option value="" selected disabled>No hay grupos disponibles</option>
                ) : (
                  <>
                    <option value="" selected={!preGrupo} disabled>Selecciona un grupo</option>
                    {grupos.map((g) => (
                      <option value={g.Nombre} selected={preGrupo === g.Nombre}>
                        {g.Nombre}
                      </option>
                    ))}
                  </>
                )}
              </select>

              <span class="chev" aria-hidden="true">▾</span>
            </div>
          </div>

          <!-- Email (full) -->
          <div class={`control span-2 ${emailExists ? "is-error" : ""}`} id="emailControl">
            <div class="control-head">
              <span class="ico" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M4 7h16v10H4z" stroke="currentColor" stroke-width="2"/>
                  <path d="m4 8 8 6 8-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              <label for="email">Correo electrónico <span class="req">*</span></label>
            </div>
            <div class="control-body">
              <span class="ico soft" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M4 7h16v10H4z" stroke="currentColor" stroke-width="2"/>
                  <path d="m4 8 8 6 8-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              <input
                type="email"
                name="email"
                id="email"
                required
                placeholder="Ingresa tu correo"
                value={preEmail}
              />
            </div>

            <!-- fallback por query -->
            {emailExists && (
              <p class="hint-row hint-error">Este correo ya existe.</p>
            )}

            <!-- mensaje por precheck (JS) -->
            <p class="hint-row hint-error" id="emailExistsMsg" hidden>
              Este correo ya existe.
            </p>
          </div>

          <!-- Password (full) -->
          <div class="control span-2" id="passwordControl">
            <div class="control-head">
              <span class="ico" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M7 11V8a5 5 0 0 1 10 0v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M6 11h12v9H6z" stroke="currentColor" stroke-width="2"/>
                </svg>
              </span>
              <label for="password">Contraseña <span class="req">*</span></label>
            </div>
            <div class="control-body">
              <span class="ico soft" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M7 11V8a5 5 0 0 1 10 0v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M6 11h12v9H6z" stroke="currentColor" stroke-width="2"/>
                </svg>
              </span>
              <input type="password" name="password" id="password" required minlength="6" placeholder="Crea una contraseña" />
            </div>
            <p class="hint-row">Mínimo 6 caracteres.</p>
          </div>

          <!-- Confirm password (full) -->
          <div class="control span-2" id="passwordConfirmControl">
            <div class="control-head">
              <span class="ico" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M7 11V8a5 5 0 0 1 10 0v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M6 11h12v9H6z" stroke="currentColor" stroke-width="2"/>
                  <path d="m9 15 2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              <label for="passwordConfirm">Confirmar contraseña <span class="req">*</span></label>
            </div>
            <div class="control-body">
              <span class="ico soft" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M7 11V8a5 5 0 0 1 10 0v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M6 11h12v9H6z" stroke="currentColor" stroke-width="2"/>
                  <path d="m9 15 2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              <input type="password" name="passwordConfirm" id="passwordConfirm" required minlength="6" placeholder="Confirma tu contraseña" />
            </div>

            <p class="hint-row hint-error" id="passwordMismatch" hidden>
              Las contraseñas no coinciden.
            </p>

            {passMismatch && (
              <p class="hint-row hint-error">Las contraseñas no coinciden.</p>
            )}
          </div>
        </div>

        <button class="btn" type="submit" id="submitBtn">
          <span>Crear cuenta</span>
          <span class="arrow" aria-hidden="true">→</span>
        </button>
      </form>
    </div>
  </section>
</Layout>

<style>
  /* Todo CLARO / BLANCO */
  .auth{min-height:calc(100vh - 120px);display:grid;place-items:center;padding:44px 16px;background:#f6f8fc;}
  .card{width:min(880px,100%);background:#fff;border:1px solid rgba(15,23,42,.10);border-radius:18px;padding:28px;box-shadow:0 14px 38px rgba(2,6,23,.10);}
  .head{text-align:center;}
  .head h1{margin:0;font-size:2.1rem;letter-spacing:-.02em;color:#0f172a;}
  .sub{margin:10px 0 0;color:#64748b;font-size:1rem;}
  .sub a{color:#2563eb;text-decoration:underline;text-underline-offset:3px;font-weight:700;}
  .divider{height:1px;background:rgba(15,23,42,.10);margin:18px -28px 20px;}
  .divider.soft{margin:18px -28px 14px;background:rgba(15,23,42,.07);}

  .top-alert{
    margin:12px auto 0;
    width:min(640px,100%);
    background:rgba(239,68,68,.08);
    border:1px solid rgba(239,68,68,.22);
    color:#b91c1c;
    padding:10px 12px;
    border-radius:12px;
    font-weight:700;
    font-size:.95rem;
  }

  .register-form{display:flex;flex-direction:column;gap:16px;}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
  .span-2{grid-column:1 / -1;}
  .req{color:#ef4444;font-weight:900;}

  .control{border:1px solid rgba(15,23,42,.12);border-radius:12px;overflow:hidden;background:#fff;}
  .control-head,.control-body{display:flex;align-items:center;gap:10px;padding:10px 12px;}
  .control-head{border-bottom:1px solid rgba(15,23,42,.10);background:#fff;}
  .control-head label{font-size:.98rem;font-weight:800;color:#0f172a;}
  .control-body{background:#f8fafc;}

  /* iconos chicos */
  .ico{width:18px;height:18px;display:inline-flex;color:#2563eb;flex:0 0 auto;}
  .ico svg{width:18px;height:18px;display:block;}
  .ico.soft{color:#64748b;opacity:.95;}
  .ico.teal{color:#14b8a6;}

  input,select{border:none;outline:none;width:100%;background:transparent;font-size:1rem;color:#0f172a;padding:2px 0;}
  input::placeholder{color:#94a3b8;}
  select{appearance:none;-webkit-appearance:none;-moz-appearance:none;}
  .chev{color:#64748b;font-size:1.1rem;line-height:1;user-select:none;}

  .hint-row{margin:8px 12px 12px;color:#64748b;font-size:.9rem;}
  .hint-error{color:#ef4444;font-weight:800;}

  .btn{
    margin-top:6px;
    width:min(520px,100%);
    align-self:center;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    padding:13px 14px;
    border-radius:12px;
    border:1px solid rgba(37,99,235,.35);
    background:linear-gradient(180deg,#2563eb,#1d4ed8);
    color:white;
    font-size:1.12rem;
    font-weight:900;
    cursor:pointer;
    box-shadow:0 12px 22px rgba(37,99,235,.18);
  }
  .btn:active{transform:translateY(1px);}
  .btn:disabled{opacity:.75;cursor:not-allowed;filter:saturate(.9);}
  .arrow{font-size:1.2rem;opacity:.95;}

  /* error state */
  .control.is-error{border-color:rgba(239,68,68,.75);box-shadow:0 0 0 4px rgba(239,68,68,.12);}
  .control.is-error .control-body{background:rgba(239,68,68,.06);}
  .control.is-error .ico{color:#ef4444;}

  @media (max-width:720px){
    .card{padding:22px;}
    .divider{margin-left:-22px;margin-right:-22px;}
    .grid{grid-template-columns:1fr;}
    .span-2{grid-column:auto;}
  }
</style>

<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("registerForm");
    const submitBtn = document.getElementById("submitBtn");

    const email = document.getElementById("email");
    const boleta = document.getElementById("boleta");

    const emailControl = document.getElementById("emailControl");
    const boletaControl = document.getElementById("boletaControl");

    const emailMsg = document.getElementById("emailExistsMsg");
    const boletaMsg = document.getElementById("boletaExistsMsg");

    const pass = document.getElementById("password");
    const confirm = document.getElementById("passwordConfirm");
    const mismatchMsg = document.getElementById("passwordMismatch");

    const passControl = document.getElementById("passwordControl");
    const confirmControl = document.getElementById("passwordConfirmControl");

    if (!(form instanceof HTMLFormElement)) return;
    if (!(email instanceof HTMLInputElement)) return;
    if (!(boleta instanceof HTMLInputElement)) return;
    if (!(pass instanceof HTMLInputElement)) return;
    if (!(confirm instanceof HTMLInputElement)) return;

    const setBtn = (loading, text) => {
      if (!(submitBtn instanceof HTMLButtonElement)) return;
      submitBtn.disabled = loading;
      submitBtn.textContent = text;
    };

    const clearExistsErrors = () => {
      emailControl?.classList.remove("is-error");
      boletaControl?.classList.remove("is-error");
      emailMsg?.setAttribute("hidden", "true");
      boletaMsg?.setAttribute("hidden", "true");
    };

    const validatePasswords = () => {
      const mismatch =
        pass.value.length > 0 &&
        confirm.value.length > 0 &&
        pass.value !== confirm.value;

      passControl?.classList.toggle("is-error", mismatch);
      confirmControl?.classList.toggle("is-error", mismatch);

      confirm.setCustomValidity(mismatch ? "Las contraseñas no coinciden" : "");
      if (mismatchMsg) mismatchMsg.toggleAttribute("hidden", !mismatch);

      return !mismatch;
    };

    pass.addEventListener("input", validatePasswords);
    confirm.addEventListener("input", validatePasswords);

    email.addEventListener("input", () => {
      emailControl?.classList.remove("is-error");
      emailMsg?.setAttribute("hidden", "true");
    });

    boleta.addEventListener("input", () => {
      boletaControl?.classList.remove("is-error");
      boletaMsg?.setAttribute("hidden", "true");
    });

    form.addEventListener("submit", async (e) => {
      // 1) validación nativa del navegador
      if (!form.checkValidity()) {
        e.preventDefault();
        form.reportValidity();
        return;
      }

      // 2) contraseñas deben coincidir
      const okPasswords = validatePasswords();
      if (!okPasswords) {
        e.preventDefault();
        confirm.focus();
        return;
      }

      // 3) precheck antes de enviar
      e.preventDefault();
      clearExistsErrors();
      setBtn(true, "Verificando...");

      try {
        const res = await fetch("/api/auth/precheck", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            email: email.value.trim(),
            boleta: boleta.value.trim(),
          }),
        });

        const json = await res.json().catch(() => ({}));

        // si precheck falla, dejamos que el backend valide
        if (!res.ok) {
          console.error("Precheck failed:", res.status, json);
          setBtn(true, "Creando cuenta...");
          form.submit();
          return;
        }

        let hasError = false;

        if (json.email_exists) {
          emailControl?.classList.add("is-error");
          emailMsg?.removeAttribute("hidden");
          hasError = true;
        }

        if (json.boleta_exists) {
          boletaControl?.classList.add("is-error");
          boletaMsg?.removeAttribute("hidden");
          hasError = true;
        }

        if (hasError) {
          setBtn(false, "Crear cuenta");
          if (json.boleta_exists) boleta.focus();
          else email.focus();
          return;
        }

        // ✅ todo ok -> enviar
        setBtn(true, "Creando cuenta...");
        form.submit();
      } catch (err) {
        console.error("Precheck error:", err);
        // fallback: enviar y que el backend haga la validación
        setBtn(true, "Creando cuenta...");
        form.submit();
      }
    });
  });
</script>
