---
import DashboardLayout from '../layouts/DashboardLayout.astro';
import '../styles/style.css';
---

<DashboardLayout>
  <section class="content">
    <!-- ===== Panel central: Asignación de práctica (Generación de código) ===== -->
    <section class="asignar-wrap">
      <header class="asignar-head">
        <h1>Asignación de práctica <small>(Generación de código)</small></h1>
        <p class="asignar-desc">
          En esta sección puedes generar un código único y asignar una práctica específica a tu grupo de alumnos.
        </p>
      </header>

      <div class="asignar-card">
        <!-- Selección de práctica -->
        <div class="asignar-row">
          <label for="practica-select" class="asignar-label">Selecciona la práctica a realizar</label>
          <select id="practica-select" class="asignar-input">
            <option value="practica-1">Práctica 1</option>
            <option value="practica-2">Práctica 2</option>
            <option value="practica-3">Práctica 3</option>
          </select>
        </div>

        <!-- Código de práctica -->
        <div class="asignar-row">
          <label for="codigo-input" class="asignar-label">Código de la práctica</label>
          <div class="asignar-code-row">
            <input id="codigo-input" class="asignar-input asignar-code" type="text" value="ABC123" readonly />
            <button id="generar-btn" class="asignar-btn secundario" type="button">Generar código</button>
          </div>
        </div>

        <!-- Botón principal -->
        <div class="asignar-actions">
          <button id="asignar-btn" class="asignar-btn primario" type="button">Asignar</button>
        </div>
      </div>
    </section>

    <!-- Script ligero del lado del cliente -->
<script is:inline type="module">
  // Importa el cliente EN EL NAVEGADOR
  import { supabase } from '/src/lib/supabaseClient.js';

  // Generador simple
  function generarCodigo(len = 6) {
    const letras = 'ABCDEFGHJKLMNPQRSTUVWXYZ';
    const nums   = '23456789';
    const pool   = letras + nums;
    let out = '';
    for (let i = 0; i < len; i++) out += pool[Math.floor(Math.random() * pool.length)];
    return out;
  }

  // Referencias UI
  const inputCodigo = document.getElementById('codigo-input');
  const btnGenerar  = document.getElementById('generar-btn');
  const btnAsignar  = document.getElementById('asignar-btn');
  const selectPract = document.getElementById('practica-select');

  // Mapa: opción del select -> fila real en BD
  // ⚠️ Ajusta los IDs y títulos a tu tabla real
  const PRACTICA_MAP = {
    'practica-1': { id: 1, titulo: 'Multimodo y monomodo' },
    'practica-2': { id: 2, titulo: 'Principios de uso en OTDR' },
    'practica-3': { id: 3, titulo: 'Principios de fibra optica' },
  };

  // Lee el Codigo actual de la práctica seleccionada
  async function cargarCodigoActual() {
    const meta = PRACTICA_MAP[selectPract.value];
    if (!meta?.id) { inputCodigo.value = ''; return; }
    try {
      const { data, error } = await supabase
        .from('Practicas')     // ⚠️ nombre exacto de la tabla (respetar mayúsculas)
        .select('Codigo')      // ⚠️ nombre exacto de la columna
        .eq('id', meta.id)
        .maybeSingle();

      if (error) throw error;
      inputCodigo.value = data?.Codigo ?? '';
    } catch (e) {
      console.error('[Leer Codigo]', e);
      inputCodigo.value = '';
    }
  }

  // Generar visualmente
  btnGenerar?.addEventListener('click', () => {
    inputCodigo.value = generarCodigo(6);
    inputCodigo.classList.add('asignar-pulse');
    setTimeout(() => inputCodigo.classList.remove('asignar-pulse'), 500);
  });

  // Actualizar SOLO "Codigo" en Supabase
  btnAsignar?.addEventListener('click', async () => {
    const meta = PRACTICA_MAP[selectPract.value];
    if (!meta?.id) {
      alert('Selecciona una práctica válida o completa el mapeo de IDs.');
      return;
    }
    const codigo = (inputCodigo.value || generarCodigo(6)).trim();

    try {
      const { data, error } = await supabase
        .from('Practicas')          // ⚠️ tabla exacta
        .update({ Codigo: codigo }) // ⚠️ columna exacta
        .eq('id', meta.id)
        .select();

      if (error) throw error;
      alert(`✅ Código actualizado:\n• ${meta.titulo}\n• Código: ${codigo}\n\nid: ${data?.[0]?.id ?? meta.id}`);
    } catch (e) {
      console.error('[UPDATE Codigo]', e);
      alert(`❌ No se pudo actualizar: ${e?.message ?? 'Error desconocido'}`);
    }
  });

  // Cargar el código al entrar y al cambiar la práctica
  selectPract?.addEventListener('change', cargarCodigoActual);
  cargarCodigoActual();
</script>

  </section>
</DashboardLayout>

<style>
/* ====== Panel Asignar práctica ====== */
.asignar-wrap{
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  margin-top: 0; /* sin espacio extra arriba */
  text-align: center;
}

.asignar-head h1{
  font-size: clamp(1.3rem, 2.5vw, 1.6rem);
  font-weight: 700;
  color: #111827;
  margin-bottom: 0.4rem;
}

.asignar-head small{
  color:#6b7280;
  font-weight: 500;
}

.asignar-desc {
  font-size: 0.95rem;
  color: #4b5563;
  margin-bottom: 1.5rem;
}

.asignar-card{
  width: min(500px, 90%);
  display: flex;
  flex-direction: column;
  gap: 1.2rem;
  background: transparent; /* sin recuadro */
  border: none;
  box-shadow: none;
}

.asignar-row {
  text-align: left;
}

.asignar-label{
  display:block;
  margin-bottom: .4rem;
  font-size:.95rem;
  color:#374151;
  font-weight:600;
}

.asignar-input{
  width:100%;
  border:1px solid #d1d5db;
  border-radius:10px;
  padding:.7rem .9rem;
  font-size:1rem;
  outline:none;
  background:#fff;
}

.asignar-input:focus{
  border-color:#3b82f6;
  box-shadow:0 0 0 3px rgba(59,130,246,.15);
}

.asignar-code-row{
  display:flex;
  gap:.75rem;
  align-items:center;
}

.asignar-code{
  flex:1;
  font-weight:700;
  letter-spacing:.06em;
  text-align:center;
}

.asignar-actions{
  display:flex;
  justify-content:center;
  margin-top: 1rem;
}

.asignar-btn{
  border:none;
  border-radius:12px;
  padding:.75rem 1.25rem;
  font-weight:600;
  cursor:pointer;
}

.asignar-btn.primario{
  background:#294aa6;
  color:#fff;
}

.asignar-btn.primario:hover{
  filter:brightness(0.95);
}

.asignar-btn.secundario{
  background:#e5ecff;
  color:#1f3a8a;
}

.asignar-btn.secundario:hover{
  filter:brightness(0.97);
}

@keyframes asignarPulse{
  from{ box-shadow:0 0 0 0 rgba(59,130,246,.35);}
  to{ box-shadow:0 0 0 10px rgba(59,130,246,0);}
}

.asignar-pulse{
  animation: asignarPulse .5s ease-out 1;
}

/* --- Estilo personalizado del select --- */
.asignar-input[type="text"],
.asignar-input[type="number"],
.asignar-input[type="email"],
.asignar-input[type="password"],
.asignar-input:not([type]) {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
}

/* Estilo específico para el SELECT */
#practica-select {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  background-color: #fff;
  border: 1px solid #d1d5db;
  border-radius: 10px;
  padding: 0.7rem 1rem;
  font-size: 1rem;
  font-weight: 500;
  color: #1f2937;
  width: 100%;
  outline: none;
  cursor: pointer;
  background-image: linear-gradient(45deg, transparent 50%, #294aa6 50%), 
                    linear-gradient(135deg, #294aa6 50%, transparent 50%);
  background-position: calc(100% - 18px) center, calc(100% - 13px) center;
  background-size: 6px 6px, 6px 6px;
  background-repeat: no-repeat;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

#practica-select:hover {
  border-color: #294aa6;
}

#practica-select:focus {
  border-color: #294aa6;
  box-shadow: 0 0 0 3px rgba(41, 74, 166, 0.15);
}

/* Opciones internas */
#practica-select option {
  background-color: #fff;
  color: #1f2937;
  font-weight: 500;
}

</style>
